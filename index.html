<script>
        const PASSWORDS = {
            UPLOAD: "gambia@2025",
            DOWNLOAD: "gambia@@2025"
        };
        
        const CONFIG = {
            STORAGE_KEY: "webcred_files",
            MAX_FILE_SIZE: 50 * 1024 * 1024,
            ALLOWED_TYPES: [
                'text/csv',
                'application/vnd.ms-excel',
                'application/vnd.openxmlformats-officedocument.spreadsheetml.sheet',
                'application/pdf',
                'image/jpeg',
                'image/png',
                'image/gif',
                'application/zip',
                'application/x-zip-compressed',
                'text/plain',
                'application/msword',
                'application/vnd.openxmlformats-officedocument.wordprocessingml.document'
            ]
        };
        
        let state = {
            currentUser: null,
            currentOrg: null,
            isAuthenticated: false,
            selectedFiles: [],
            uploadedFiles: [],
            allFilesSelected: false,
            currentFilter: 'all'
        };
        
        const elements = {
            passwordOverlay: document.getElementById('password-overlay'),
            mainContent: document.getElementById('main-content'),
            passwordInput: document.getElementById('password-input'),
            loginBtn: document.getElementById('login-btn'),
            passwordError: document.getElementById('password-error'),
            logoutBtn: document.getElementById('logout-btn'),
            exportAllCsv: document.getElementById('export-all-csv'),
            uploadForm: document.getElementById('upload-form'),
            fileInput: document.getElementById('file-input'),
            fileUploadArea: document.getElementById('file-upload-area'),
            selectedFilesContainer: document.getElementById('selected-files'),
            submitUpload: document.getElementById('submit-upload'),
            filesList: document.getElementById('files-list'),
            emptyState: document.getElementById('empty-state'),
            loadingFiles: document.getElementById('loading-files'),
            filesCount: document.getElementById('files-count'),
            bulkActions: document.getElementById('bulk-actions'),
            selectAllFiles: document.getElementById('select-all-files'),
            bulkDownload: document.getElementById('bulk-download'),
            bulkCsv: document.getElementById('bulk-csv'),
            bulkDelete: document.getElementById('bulk-delete'),
            notification: document.getElementById('notification'),
            notificationClose: document.getElementById('notification-close'),
            notificationTitle: document.getElementById('notification-title'),
            notificationMessage: document.getElementById('notification-message'),
            currentUserDisplay: document.getElementById('current-user'),
            userNameDisplay: document.getElementById('user-name'),
            fileClassified: document.getElementById('file-classified')
        };
        
        function createStars() {
            const starsContainer = document.getElementById('stars-container');
            const starsCount = 150;
            
            for (let i = 0; i < starsCount; i++) {
                const star = document.createElement('div');
                star.className = 'star';
                const size = Math.random() * 3 + 1;
                star.style.width = `${size}px`;
                star.style.height = `${size}px`;
                star.style.left = `${Math.random() * 100}%`;
                star.style.top = `${Math.random() * 100}%`;
                star.style.animationDelay = `${Math.random() * 5}s`;
                star.style.animationDuration = `${Math.random() * 3 + 2}s`;
                starsContainer.appendChild(star);
            }
        }
        
        function formatFileSize(bytes) {
            if (bytes === 0) return '0 Bytes';
            const k = 1024;
            const sizes = ['Bytes', 'KB', 'MB', 'GB'];
            const i = Math.floor(Math.log(bytes) / Math.log(k));
            return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
        }
        
        function getFileIcon(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (ext === 'csv') return 'csv-icon fas fa-file-csv';
            if (ext === 'pdf') return 'pdf-icon fas fa-file-pdf';
            if (['doc', 'docx'].includes(ext)) return 'doc-icon fas fa-file-word';
            if (['xls', 'xlsx'].includes(ext)) return 'xls-icon fas fa-file-excel';
            if (['jpg', 'jpeg', 'png', 'gif', 'bmp'].includes(ext)) return 'img-icon fas fa-file-image';
            if (['zip', 'rar', '7z'].includes(ext)) return 'zip-icon fas fa-file-archive';
            return 'fas fa-file';
        }
        
        function getFileType(filename) {
            const ext = filename.split('.').pop().toLowerCase();
            if (ext === 'csv') return 'CSV';
            if (ext === 'pdf') return 'PDF';
            if (['doc', 'docx'].includes(ext)) return 'Word Document';
            if (['xls', 'xlsx'].includes(ext)) return 'Excel Spreadsheet';
            if (['jpg', 'jpeg'].includes(ext)) return 'JPEG Image';
            if (ext === 'png') return 'PNG Image';
            if (ext === 'gif') return 'GIF Image';
            if (['zip', 'rar', '7z'].includes(ext)) return 'Archive';
            return 'File';
        }
        
        function showNotification(title, message, type = 'success') {
            elements.notificationTitle.textContent = title;
            elements.notificationMessage.textContent = message;
            elements.notification.className = `notification ${type} show`;
            
            setTimeout(() => {
                hideNotification();
            }, 5000);
        }
        
        function hideNotification() {
            elements.notification.classList.remove('show');
        }
        
        function formatDate(date) {
            return new Date(date).toLocaleString('en-US', {
                year: 'numeric',
                month: 'short',
                day: 'numeric',
                hour: '2-digit',
                minute: '2-digit'
            });
        }
        
        function generateId() {
            return Date.now().toString(36) + Math.random().toString(36).substr(2);
        }
        
        function readFileAsDataURL(file) {
            return new Promise((resolve, reject) => {
                const reader = new FileReader();
                reader.onload = () => resolve(reader.result);
                reader.onerror = () => reject(reader.error);
                reader.readAsDataURL(file);
            });
        }
        
        function downloadCSV(files, filename = 'webcred_files') {
            if (files.length === 0) {
                showNotification('No Files', 'No files to export', 'warning');
                return;
            }
            
            const headers = [
                'File Name',
                'Uploader Name',
                'Organization',
                'Purpose',
                'Description',
                'File Type',
                'File Size',
                'Upload Date',
                'Classified'
            ];
            
            let csvContent = headers.join(',') + '\n';
            
            files.forEach(file => {
                const row = [
                    `"${file.name.replace(/"/g, '""')}"`,
                    `"${file.uploaderName.replace(/"/g, '""')}"`,
                    `"${file.organization.replace(/"/g, '""')}"`,
                    `"${file.purpose.replace(/"/g, '""')}"`,
                    `"${file.description.replace(/"/g, '""')}"`,
                    `"${getFileType(file.name)}"`,
                    `"${formatFileSize(file.size)}"`,
                    `"${formatDate(file.uploadedAt)}"`,
                    `"${file.classified ? 'YES' : 'NO'}"`
                ].join(',');
                
                csvContent += row + '\n';
            });
            
            const encodedUri = 'data:text/csv;charset=utf-8,' + encodeURIComponent(csvContent);
            const link = document.createElement('a');
            link.setAttribute('href', encodedUri);
            link.setAttribute('download', `${filename}_${new Date().toISOString().split('T')[0]}.csv`);
            document.body.appendChild(link);
            link.click();
            document.body.removeChild(link);
            
            showNotification('CSV Downloaded', `${files.length} files exported to CSV`, 'success');
        }
        
        function exportSingleFileCSV(fileId) {
            const password = prompt("Enter download password to export CSV:");
            if (password !== PASSWORDS.DOWNLOAD) {
                showNotification('Access Denied', 'Invalid download password', 'error');
                return;
            }
            
            const file = state.uploadedFiles.find(f => f.id === fileId);
            if (file) {
                downloadCSV([file], `file_${file.name.replace(/\.[^/.]+$/, '')}`);
            }
        }
        
        function exportSelectedFilesCSV() {
            if (state.selectedFiles.length === 0) {
                showNotification('No Selection', 'Please select files for CSV export', 'warning');
                return;
            }
            
            const password = prompt("Enter download password to export CSV:");
            if (password !== PASSWORDS.DOWNLOAD) {
                showNotification('Access Denied', 'Invalid download password', 'error');
                return;
            }
            
            const filesToExport = state.uploadedFiles.filter(file => 
                state.selectedFiles.includes(file.id)
            );
            
            downloadCSV(filesToExport, 'webcred_selected_files');
        }
        
        function exportAllFilesCSV() {
            let filesToExport = state.uploadedFiles;
            
            if (state.currentFilter === 'classified') {
                filesToExport = filesToExport.filter(file => file.classified);
            } else if (state.currentFilter === 'csv') {
                filesToExport = filesToExport.filter(file => file.name.toLowerCase().endsWith('.csv'));
            }
            
            if (filesToExport.length === 0) {
                showNotification('No Files', 'No files to export', 'warning');
                return;
            }
            
            const password = prompt("Enter download password to export CSV:");
            if (password !== PASSWORDS.DOWNLOAD) {
                showNotification('Access Denied', 'Invalid download password', 'error');
                return;
            }
            
            downloadCSV(filesToExport, 'webcred_all_files');
        }
        
        function checkAuth() {
            const isLoggedIn = sessionStorage.getItem('webcred_logged_in') === 'true';
            const user = sessionStorage.getItem('webcred_user');
            const org = sessionStorage.getItem('webcred_org');
            
            if (isLoggedIn && user && org) {
                state.isAuthenticated = true;
                state.currentUser = user;
                state.currentOrg = org;
                
                elements.passwordOverlay.style.display = 'none';
                elements.mainContent.style.display = 'block';
                createStars();
                updateUserDisplay();
                loadFiles();
                return true;
            }
            return false;
        }
        
        function login() {
            const password = elements.passwordInput.value.trim();
            
            if (password === PASSWORDS.UPLOAD) {
                const userName = document.getElementById('uploader-name').value || 'WebCred User';
                const userOrg = document.getElementById('uploader-org').value || 'WebCred Solutions';
                
                state.isAuthenticated = true;
                state.currentUser = userName;
                state.currentOrg = userOrg;
                
                sessionStorage.setItem('webcred_logged_in', 'true');
                sessionStorage.setItem('webcred_user', userName);
                sessionStorage.setItem('webcred_org', userOrg);
                
                elements.passwordOverlay.style.opacity = '0';
                setTimeout(() => {
                    elements.passwordOverlay.style.display = 'none';
                    elements.mainContent.style.display = 'block';
                    createStars();
                    updateUserDisplay();
                    loadFiles();
                    showNotification('Access Granted', 'Welcome to WebCred Solutions', 'success');
                }, 300);
                
                elements.passwordInput.value = '';
                elements.passwordError.textContent = '';
            } else {
                elements.passwordError.textContent = "Invalid password";
                elements.passwordInput.style.borderColor = "#ff6b6b";
                elements.passwordInput.style.animation = 'none';
                setTimeout(() => {
                    elements.passwordInput.style.animation = 'shake 0.5s';
                }, 10);
                
                setTimeout(() => {
                    elements.passwordInput.value = '';
                    elements.passwordInput.focus();
                }, 1500);
            }
        }
        
        function logout() {
            if (confirm('Are you sure you want to logout?')) {
                sessionStorage.removeItem('webcred_logged_in');
                sessionStorage.removeItem('webcred_user');
                sessionStorage.removeItem('webcred_org');
                
                state.isAuthenticated = false;
                state.currentUser = null;
                state.currentOrg = null;
                state.selectedFiles = [];
                
                elements.mainContent.style.display = 'none';
                elements.passwordOverlay.style.display = 'flex';
                elements.passwordOverlay.style.opacity = '1';
                elements.passwordInput.value = '';
                elements.passwordError.textContent = '';
                elements.passwordInput.style.borderColor = 'var(--gold)';
                
                resetUploadForm();
                showNotification('Logged Out', 'You have been logged out', 'success');
            }
        }
        
        function updateUserDisplay() {
            if (state.currentUser) {
                elements.currentUserDisplay.textContent = `Portal Access: Active`;
                elements.userNameDisplay.textContent = state.currentUser;
            }
        }
        
        function loadFiles() {
            elements.loadingFiles.style.display = 'block';
            elements.emptyState.style.display = 'none';
            
            setTimeout(() => {
                try {
                    const storedFiles = localStorage.getItem(CONFIG.STORAGE_KEY);
                    state.uploadedFiles = storedFiles ? JSON.parse(storedFiles) : [];
                    state.uploadedFiles.sort((a, b) => new Date(b.uploadedAt) - new Date(a.uploadedAt));
                    
                    renderFilesList();
                    updateFilesCount();
                    
                    elements.loadingFiles.style.display = 'none';
                    
                    if (state.uploadedFiles.length === 0) {
                        elements.emptyState.style.display = 'block';
                    }
                } catch (error) {
                    console.error('Error loading files:', error);
                    state.uploadedFiles = [];
                    elements.loadingFiles.style.display = 'none';
                    elements.emptyState.style.display = 'block';
                    showNotification('Error', 'Failed to load files', 'error');
                }
            }, 500);
        }
        
        function saveFiles() {
            try {
                localStorage.setItem(CONFIG.STORAGE_KEY, JSON.stringify(state.uploadedFiles));
                return true;
            } catch (error) {
                console.error('Error saving files:', error);
                showNotification('Storage Error', 'Failed to save files', 'error');
                return false;
            }
        }
        
        function renderFilesList() {
            elements.filesList.innerHTML = '';
            
            let filesToShow = state.uploadedFiles;
            
            if (state.currentFilter === 'classified') {
                filesToShow = filesToShow.filter(file => file.classified);
            } else if (state.currentFilter === 'csv') {
                filesToShow = filesToShow.filter(file => file.name.toLowerCase().endsWith('.csv'));
            }
            
            if (filesToShow.length === 0) {
                elements.emptyState.style.display = 'block';
                elements.bulkActions.style.display = 'none';
                return;
            }
            
            elements.emptyState.style.display = 'none';
            
            filesToShow.forEach(file => {
                const fileItem = document.createElement('div');
                fileItem.className = `file-item ${file.classified ? 'classified' : ''} fade-in`;
                fileItem.dataset.id = file.id;
                
                const isSelected = state.selectedFiles.includes(file.id);
                if (isSelected) {
                    fileItem.style.borderColor = 'var(--gold)';
                    fileItem.style.boxShadow = '0 5px 20px rgba(255, 215, 0, 0.2)';
                }
                
                const fileIconClass = getFileIcon(file.name);
                const fileType = getFileType(file.name);
                const fileSize = formatFileSize(file.size);
                const uploadDate = formatDate(file.uploadedAt);
                
                fileItem.innerHTML = `
                    ${file.classified ? '<div class="classified-badge"><i class="fas fa-lock"></i> CLASSIFIED</div>' : ''}
                    <div class="file-item-header">
                        <div class="file-info">
                            <div class="file-icon ${fileIconClass.split(' ')[0]}">
                                <i class="${fileIconClass}"></i>
                            </div>
                            <div class="file-details">
                                <h4>${file.name}</h4>
                                <div class="file-meta">
                                    <span><i class="fas fa-user"></i> ${file.uploaderName}</span>
                                    <span><i class="fas fa-building"></i> ${file.organization}</span>
                                    <span><i class="fas fa-tag"></i> ${file.purpose}</span>
                                    <span><i class="fas fa-file"></i> ${fileType}</span>
                                    <span><i class="fas fa-weight-hanging"></i> ${fileSize}</span>
                                    <span><i class="fas fa-clock"></i> ${uploadDate}</span>
                                </div>
                            </div>
                        </div>
                        <div class="file-actions">
                            <button class="action-btn download-btn" onclick="downloadFileNow('${file.id}')">
                                <i class="fas fa-download"></i> Download
                            </button>
                            <button class="action-btn csv-btn" onclick="exportSingleFileCSV('${file.id}')">
                                <i class="fas fa-file-csv"></i> CSV
                            </button>
                            <button class="action-btn delete-btn" onclick="deleteFile('${file.id}')">
                                <i class="fas fa-trash"></i> Delete
                            </button>
                        </div>
                    </div>
                    
                    <div class="file-description">
                        <div class="description-title">
                            <i class="fas fa-align-left"></i> Description
                        </div>
                        <div class="description-text">
                            ${file.description}
                        </div>
                    </div>
                    
                    <div class="uploader-info">
                        <div class="uploader-details">
                            <span><i class="fas fa-user-circle"></i> ${file.uploaderName}</span>
                            <span><i class="fas fa-building"></i> ${file.organization}</span>
                            <span><i class="fas fa-calendar"></i> Uploaded: ${uploadDate}</span>
                            ${file.classified ? '<span style="color: var(--classified-red);"><i class="fas fa-lock"></i> Classified</span>' : ''}
                        </div>
                        <div>
                            <input type="checkbox" class="file-select" data-id="${file.id}" ${isSelected ? 'checked' : ''} 
                                   onchange="toggleFileSelection('${file.id}', this.checked)">
                            <label>Select</label>
                        </div>
                    </div>
                `;
                
                elements.filesList.appendChild(fileItem);
            });
            
            if (state.uploadedFiles.length > 0) {
                elements.bulkActions.style.display = 'flex';
            }
        }
        
        function updateFilesCount() {
            let filesToCount = state.uploadedFiles;
            
            if (state.currentFilter === 'classified') {
                filesToCount = filesToCount.filter(file => file.classified);
            } else if (state.currentFilter === 'csv') {
                filesToCount = filesToCount.filter(file => file.name.toLowerCase().endsWith('.csv'));
            }
            
            const count = filesToCount.length;
            elements.filesCount.textContent = `${count} File${count !== 1 ? 's' : ''}`;
            elements.selectAllFiles.checked = state.allFilesSelected && count > 0;
        }
        
        async function uploadFile(fileData) {
            return new Promise(async (resolve, reject) => {
                try {
                    const fileId = generateId();
                    
                    let fileContent = null;
                    if (fileData.file instanceof File) {
                        fileContent = await readFileAsDataURL(fileData.file);
                    }
                    
                    const fileObj = {
                        id: fileId,
                        name: fileData.name,
                        size: fileData.size,
                        type: fileData.type,
                        uploaderName: fileData.uploaderName,
                        organization: fileData.organization,
                        purpose: fileData.purpose,
                        description: fileData.description,
                        classified: fileData.classified || false,
                        uploadedAt: new Date().toISOString(),
                        content: fileContent
                    };
                    
                    state.uploadedFiles.unshift(fileObj);
                    
                    if (saveFiles()) {
                        renderFilesList();
                        updateFilesCount();
                        state.selectedFiles = [];
                        state.allFilesSelected = false;
                        resolve(fileId);
                    } else {
                        reject(new Error('Failed to save file'));
                    }
                } catch (error) {
                    reject(error);
                }
            });
        }
        
        function downloadFileNow(fileId) {
            const password = prompt("Enter download password:");
            if (password !== PASSWORDS.DOWNLOAD) {
                showNotification('Access Denied', 'Invalid download password', 'error');
                return;
            }
            
            const file = state.uploadedFiles.find(f => f.id === fileId);
            if (!file) {
                showNotification('Error', 'File not found', 'error');
                return;
            }
            
            try {
                if (file.content) {
                    const link = document.createElement('a');
                    link.href = file.content;
                    link.download = file.name;
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                } else {
                    const content = `WebCred Solutions - File Information\n\n` +
                                   `File Name: ${file.name}\n` +
                                   `Uploaded By: ${file.uploaderName}\n` +
                                   `Organization: ${file.organization}\n` +
                                   `Purpose: ${file.purpose}\n` +
                                   `Description: ${file.description}\n` +
                                   `Classified: ${file.classified ? 'YES' : 'NO'}\n` +
                                   `Upload Date: ${formatDate(file.uploadedAt)}\n` +
                                   `File Size: ${formatFileSize(file.size)}`;
                    
                    const encodedUri = 'data:text/plain;charset=utf-8,' + encodeURIComponent(content);
                    const link = document.createElement('a');
                    link.setAttribute('href', encodedUri);
                    link.setAttribute('download', file.name.endsWith('.txt') ? file.name : `${file.name}.txt`);
                    document.body.appendChild(link);
                    link.click();
                    document.body.removeChild(link);
                }
                
                showNotification('Download Started', `Downloading "${file.name}"`, 'success');
            } catch (error) {
                console.error('Download error:', error);
                showNotification('Download Error', 'Failed to download file', 'error');
            }
        }
        
        function bulkDownload() {
            let filesToDownload = state.uploadedFiles.filter(file => 
                state.selectedFiles.includes(file.id)
            );
            
            if (filesToDownload.length === 0) {
                showNotification('No Selection', 'Please select files to download', 'warning');
                return;
            }
            
            const password = prompt("Enter download password:");
            if (password !== PASSWORDS.DOWNLOAD) {
                showNotification('Access Denied', 'Invalid download password', 'error');
                return;
            }
            
            showNotification('Preparing Download', `Preparing ${filesToDownload.length} files`, 'success');
            
            setTimeout(() => {
                let content = `WebCred Solutions - File Export\n\n`;
                content += `Export Date: ${new Date().toLocaleString()}\n`;
                content += `Total Files: ${filesToDownload.length}\n\n`;
                
                filesToDownload.forEach((file, index) => {
                    content += `FILE ${index + 1}: ${file.name}\n`;
                    content += `Uploaded By: ${file.uploaderName}\n`;
                    content += `Organization: ${file.organization}\n`;
                    content += `Purpose: ${file.purpose}\n`;
                    content += `Description: ${file.description}\n`;
                    content += `Classified: ${file.classified ? 'YES' : 'NO'}\n`;
                    content += `Upload Date: ${formatDate(file.uploadedAt)}\n`;
                    content += `File Size: ${formatFileSize(file.size)}\n`;
                    content += 'â”€'.repeat(50) + '\n\n';
                });
                
                const encodedUri = 'data:text/plain;charset=utf-8,' + encodeURIComponent(content);
                const link = document.createElement('a');
                link.setAttribute('href', encodedUri);
                link.setAttribute('download', `webcred_export_${new Date().toISOString().split('T')[0]}.txt`);
                document.body.appendChild(link);
                link.click();
                document.body.removeChild(link);
                
                showNotification('Download Complete', `${filesToDownload.length} files downloaded`, 'success');
            }, 1000);
        }
        
        function deleteFile(fileId) {
            if (confirm('Permanently delete this file?')) {
                const index = state.uploadedFiles.findIndex(f => f.id === fileId);
                if (index !== -1) {
                    const fileName = state.uploadedFiles[index].name;
                    state.uploadedFiles.splice(index, 1);
                    state.selectedFiles = state.selectedFiles.filter(id => id !== fileId);
                    
                    if (saveFiles()) {
                        renderFilesList();
                        updateFilesCount();
                        showNotification('File Deleted', `"${fileName}" deleted`, 'success');
                    } else {
                        showNotification('Error', 'Failed to delete file', 'error');
                    }
                }
            }
        }
        
        function bulkDelete() {
            const selectedCount = state.selectedFiles.length;
            
            if (selectedCount === 0) {
                showNotification('No Selection', 'Please select files to delete', 'warning');
                return;
            }
            
            if (confirm(`Permanently delete ${selectedCount} files?`)) {
                state.uploadedFiles = state.uploadedFiles.filter(file => !state.selectedFiles.includes(file.id));
                state.selectedFiles = [];
                state.allFilesSelected = false;
                
                if (saveFiles()) {
                    renderFilesList();
                    updateFilesCount();
                    showNotification('Files Deleted', `${selectedCount} files deleted`, 'success');
                } else {
                    showNotification('Error', 'Failed to delete files', 'error');
                }
            }
        }
        
        function toggleFileSelection(fileId, isSelected) {
            if (isSelected) {
                if (!state.selectedFiles.includes(fileId)) {
                    state.selectedFiles.push(fileId);
                }
            } else {
                state.selectedFiles = state.selectedFiles.filter(id => id !== fileId);
                state.allFilesSelected = false;
                elements.selectAllFiles.checked = false;
            }
            
            const fileItem = document.querySelector(`.file-item[data-id="${fileId}"]`);
            if (fileItem) {
                if (isSelected) {
                    fileItem.style.borderColor = 'var(--gold)';
                    fileItem.style.boxShadow = '0 5px 20px rgba(255, 215, 0, 0.2)';
                } else {
                    fileItem.style.borderColor = 'transparent';
                    fileItem.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.05)';
                }
            }
        }
        
        function selectAllFiles(isSelected) {
            state.allFilesSelected = isSelected;
            
            if (isSelected) {
                state.selectedFiles = state.uploadedFiles.map(file => file.id);
            } else {
                state.selectedFiles = [];
            }
            
            document.querySelectorAll('.file-select').forEach(checkbox => {
                checkbox.checked = isSelected;
            });
            
            document.querySelectorAll('.file-item').forEach(item => {
                if (isSelected) {
                    item.style.borderColor = 'var(--gold)';
                    item.style.boxShadow = '0 5px 20px rgba(255, 215, 0, 0.2)';
                } else {
                    item.style.borderColor = 'transparent';
                    item.style.boxShadow = '0 5px 15px rgba(0, 0, 0, 0.05)';
                }
            });
        }
        
        function applyFilter(filter) {
            state.currentFilter = filter;
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                if (btn.dataset.filter === filter) {
                    btn.classList.add('active');
                } else {
                    btn.classList.remove('active');
                }
            });
            
            renderFilesList();
            updateFilesCount();
        }
        
        let selectedFilesData = [];
        
        function resetUploadForm() {
            elements.uploadForm.reset();
            selectedFilesData = [];
            elements.selectedFilesContainer.innerHTML = '';
            elements.submitUpload.disabled = true;
            elements.fileClassified.checked = false;
            updateUserInfo();
        }
        
        function updateUserInfo() {
            const userName = sessionStorage.getItem('webcred_user');
            const userOrg = sessionStorage.getItem('webcred_org');
            
            if (userName && userOrg) {
                document.getElementById('uploader-name').value = userName;
                document.getElementById('uploader-org').value = userOrg;
            }
        }
        
        function handleFileSelect(files) {
            selectedFilesData = [];
            
            for (let i = 0; i < files.length; i++) {
                const file = files[i];
                
                if (file.size > CONFIG.MAX_FILE_SIZE) {
                    showNotification('File Too Large', `"${file.name}" exceeds 50MB limit`, 'error');
                    continue;
                }
                
                if (!CONFIG.ALLOWED_TYPES.includes(file.type) && !file.name.match(/\.(csv|pdf|docx?|xlsx?|jpg|jpeg|png|gif|zip|txt)$/i)) {
                    showNotification('Invalid File Type', `"${file.name}" type not allowed`, 'error');
                    continue;
                }
                
                selectedFilesData.push(file);
            }
            
            displaySelectedFiles();
            elements.submitUpload.disabled = selectedFilesData.length === 0;
        }
        
        function displaySelectedFiles() {
            elements.selectedFilesContainer.innerHTML = '';
            
            if (selectedFilesData.length === 0) {
                return;
            }
            
            selectedFilesData.forEach((file, index) => {
                const fileElement = document.createElement('div');
                fileElement.className = 'selected-file';
                fileElement.innerHTML = `
                    <div>
                        <div class="file-name">${file.name}</div>
                        <div class="file-size">${formatFileSize(file.size)}</div>
                    </div>
                    <button type="button" class="delete-btn" style="padding: 5px 10px;" onclick="removeSelectedFile(${index})">
                        <i class="fas fa-times"></i>
                    </button>
                `;
                elements.selectedFilesContainer.appendChild(fileElement);
            });
        }
        
        function removeSelectedFile(index) {
            selectedFilesData.splice(index, 1);
            displaySelectedFiles();
            elements.submitUpload.disabled = selectedFilesData.length === 0;
        }
        
        async function handleFormSubmit(event) {
            event.preventDefault();
            
            const uploaderName = document.getElementById('uploader-name').value.trim();
            const organization = document.getElementById('uploader-org').value.trim();
            const purpose = document.getElementById('file-purpose').value;
            const description = document.getElementById('file-description').value.trim();
            const classified = elements.fileClassified.checked;
            
            if (!uploaderName || !organization || !purpose || !description) {
                showNotification('Missing Information', 'Please fill all fields', 'warning');
                return;
            }
            
            if (selectedFilesData.length === 0) {
                showNotification('No File Selected', 'Please select at least one file', 'warning');
                return;
            }
            
            elements.submitUpload.disabled = true;
            elements.submitUpload.innerHTML = '<i class="fas fa-spinner fa-spin"></i> Uploading...';
            
            try {
                for (const file of selectedFilesData) {
                    const fileData = {
                        name: file.name,
                        size: file.size,
                        type: file.type,
                        uploaderName,
                        organization,
                        purpose,
                        description,
                        classified,
                        file: file
                    };
                    
                    await uploadFile(fileData);
                }
                
                showNotification('Upload Successful', `${selectedFilesData.length} files uploaded`, 'success');
                
                resetUploadForm();
                sessionStorage.setItem('webcred_user', uploaderName);
                sessionStorage.setItem('webcred_org', organization);
                updateUserDisplay();
                
            } catch (error) {
                console.error('Upload error:', error);
                showNotification('Upload Failed', 'Upload error occurred', 'error');
            } finally {
                elements.submitUpload.disabled = false;
                elements.submitUpload.innerHTML = '<i class="fas fa-upload"></i> Upload File';
            }
        }
        
        document.addEventListener('DOMContentLoaded', function() {
            if (!checkAuth()) {
                createStars();
            }
            
            const style = document.createElement('style');
            style.textContent = `
                @keyframes shake {
                    0%, 100% { transform: translateX(0); }
                    10%, 30%, 50%, 70%, 90% { transform: translateX(-5px); }
                    20%, 40%, 60%, 80% { transform: translateX(5px); }
                }
            `;
            document.head.appendChild(style);
            
            updateUserInfo();
            
            document.querySelectorAll('.filter-btn').forEach(btn => {
                btn.addEventListener('click', () => {
                    applyFilter(btn.dataset.filter);
                });
            });
        });
        
        elements.loginBtn.addEventListener('click', login);
        elements.passwordInput.addEventListener('keypress', (e) => {
            if (e.key === 'Enter') login();
        });
        
        elements.exportAllCsv.addEventListener('click', exportAllFilesCSV);
        
        elements.logoutBtn.addEventListener('click', logout);
        
        elements.fileUploadArea.addEventListener('click', () => {
            elements.fileInput.click();
        });
        
        elements.fileInput.addEventListener('change', (e) => {
            handleFileSelect(Array.from(e.target.files));
        });
        
        elements.fileUploadArea.addEventListener('dragover', (e) => {
            e.preventDefault();
            elements.fileUploadArea.style.borderColor = 'var(--diamond)';
            elements.fileUploadArea.style.background = 'rgba(255, 255, 255, 0.95)';
            elements.fileUploadArea.style.transform = 'translateY(-5px)';
        });
        
        elements.fileUploadArea.addEventListener('dragleave', () => {
            elements.fileUploadArea.style.borderColor = 'var(--gold)';
            elements.fileUploadArea.style.background = 'rgba(255, 255, 255, 0.8)';
            elements.fileUploadArea.style.transform = 'translateY(0)';
        });
        
        elements.fileUploadArea.addEventListener('drop', (e) => {
            e.preventDefault();
            elements.fileUploadArea.style.borderColor = 'var(--gold)';
            elements.fileUploadArea.style.background = 'rgba(255, 255, 255, 0.8)';
            elements.fileUploadArea.style.transform = 'translateY(0)';
            handleFileSelect(Array.from(e.dataTransfer.files));
        });
        
        elements.uploadForm.addEventListener('submit', handleFormSubmit);
        
        elements.selectAllFiles.addEventListener('change', (e) => {
            selectAllFiles(e.target.checked);
        });
        
        elements.bulkDownload.addEventListener('click', bulkDownload);
        elements.bulkCsv.addEventListener('click', exportSelectedFilesCSV);
        elements.bulkDelete.addEventListener('click', bulkDelete);
        
        elements.notificationClose.addEventListener('click', hideNotification);
        
        window.downloadFileNow = downloadFileNow;
        window.deleteFile = deleteFile;
        window.toggleFileSelection = toggleFileSelection;
        window.removeSelectedFile = removeSelectedFile;
        window.selectAllFiles = selectAllFiles;
        window.exportSingleFileCSV = exportSingleFileCSV;
    </script>
